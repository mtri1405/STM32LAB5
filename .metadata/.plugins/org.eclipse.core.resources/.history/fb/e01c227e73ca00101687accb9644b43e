/*
 * command_parser_fsm.c
 *
 *  Created on: Nov 26, 2025
 *      Author: MinhTri
 */

#include "command_parser_fsm.h"

uint8_t status = INIT;
uint8_t command_data[MAX_COMMAND_SIZE];
uint8_t command_data_index = 0;
static uint32_t cmd_timer = 0;

bool cmdEqualRST(uint8_t str[]) {
	return strcmp((char*) str, "RST") == 0;
}

bool cmdEqualOK(uint8_t str[]) {
	return strcmp((char*) str, "OK") == 0;
}

void command_parser_fsm() {
//	// Timeout handling - reset if stuck in READING state
//	if (status == READING) {
//		cmd_timer++;
//		if (cmd_timer > CMD_TIMEOUT) {
//			status = INIT;
//			command_data_index = 0;
//			cmd_timer = 0;
//		}
//	} else {
//		cmd_timer = 0;
//	}

	switch (status) {
	case INIT:
		if (buffer_character == '!') {
			status = READING;
			command_data_index = 0;
		}
		break;
	case READING:
		if (buffer_character != '!' && buffer_character != '#') {
			if (command_data_index < MAX_COMMAND_SIZE - 1) {
				command_data[command_data_index] = buffer_character;
				command_data_index++;
				cmd_timer = 0;
			}
		} else if (buffer_character == '#') {
			status = PARSING;
			command_data[command_data_index] = '\0';
			command_data_index = 0;
		}
		break;
	case PARSING:
		if (cmdEqualRST(command_data)) {
			command_status = RST;
		} else if (cmdEqualOK(command_data)) {
			command_status = OK;
		}
		status = INIT;
		break;
	default:
		break;
	}
}
